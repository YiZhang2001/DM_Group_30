---
title: "DM Group 30"
output: html_document
date: "2024-03-10"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(readr)
library(RSQLite)
library(dplyr)
library(readxl)
library(openxlsx)
library(ggplot2)
library(scales)
```

```{r my_connection}
my_connection <- RSQLite::dbConnect(RSQLite::SQLite(),"database.db")
```

# Physical Schema
```{r drop all tables in database}
tables <- RSQLite::dbListTables(my_connection)

# drop all tables
for (table in tables) {
  query <- paste("DROP TABLE IF EXISTS", table)
  RSQLite::dbExecute(my_connection, query)
}
```


```{r create tables}
RSQLite::dbExecute(my_connection,"
  CREATE TABLE 'Customers' (
    'customer_id' VARCHAR(4) PRIMARY KEY,
    'customer_first_name' VARCHAR(200) NOT NULL,
    'customer_last_name' VARCHAR(200) NOT NULL,
    'customer_gender' VARCHAR(200) NOT NULL,
    'customer_date_of_birth' Date OT NULL,
    'customer_address1' INT NOT NULL,
    'customer_address2' VARCHAR(200) NOT NULL,
    'customer_postcode' VARCHAR(6)NOT NULL,
    'customer_phone_number' VARCHAR(12) NOT NULL,
    'customer_email' VARCHAR(200) NOT NULL,
    'customer_password' VARCHAR(200) NOT NULL);
")
 
RSQLite::dbExecute(my_connection," 
  CREATE TABLE 'Vouchers' (
    'voucher_id' VARCHAR(5) PRIMARY KEY ,
    'voucher_name' VARCHAR(200) NOT NULL,
    'voucher_value' INT Not NULL,
    'voucher_starts_date' DATE Not NULL,
    'voucher_expiry_date' DATE Not NULL);
")
 
RSQLite::dbExecute(my_connection,"
  CREATE TABLE 'Suppliers' (
    'supplier_id' VARCHAR(7) PRIMARY KEY,
    'supplier_name' VARCHAR(200) NOT NULL,
    'supplier_phone_number' VARCHAR(12) NOT NULL,
    'supplier_email' VARCHAR(200) NOT NULL,
    'supplier_password' VARCHAR(200) NOT NULL,
    'supplier_address1' INT NOT NULL,
    'supplier_address2' VARCHAR(200) NOT NULL,
    'supplier_postcode' VARCHAR(6) NOT NULL,
    'supplier_sort_code' VARCHAR(10) NOT NULL,
    'supplier_account_name' VARCHAR(200) NOT NULL,
    'supplier_account_number' VARCHAR(16) NOT NULL);
")
  
RSQLite::dbExecute(my_connection,"
  CREATE TABLE 'Categories' (
    'parent_category_id' VARCHAR(3),
    'category_id' VARCHAR(5) PRIMARY KEY,
    'category_name' VARCHAR(200) NOT NULL,
    'category_description' TEXT,
    FOREIGN KEY ('parent_category_id') REFERENCES Categories ('category_id'));
")
 
RSQLite::dbExecute(my_connection," 
  CREATE TABLE 'Cards'(
    'card_number' INT PRIMARY KEY,
    'card_holder_first_name' VARCHAR(200) NOT NULL,
    'card_holder_last_name' VARCHAR(200) NOT NULL,
    'card_types' VARCHAR(200) NOT NULL,
    'card_cvv' INT NOT NULL,
    'card_expiry_date' DATE NOT NULL,
    'customer_id' VARCHAR(4),
    FOREIGN KEY ('customer_id') REFERENCES Customers('customer_id'));
")

RSQLite::dbExecute(my_connection,"
  CREATE TABLE 'Products' (
    'product_id' VARCHAR(7) PRIMARY KEY,
    'product_name' VARCHAR(200) NOT NULL,
    'product_price' DOUBLE NOT NULL,
    'product_quantity' INT NOT NULL,
    'product_description' TEXT,
    'supplier_id' VARCHAR(7),
    'category_id' VARCHAR(5),
    FOREIGN KEY ('supplier_id') REFERENCES Suppliers('supplier_id'),
    FOREIGN KEY ('category_id') REFERENCES Categories('category_id'));
")

RSQLite::dbExecute(my_connection,"
  CREATE TABLE 'Orders_Details' (
    'order_id' VARCHAR(5) PRIMARY KEY,
    'order_date' DATE NOT NULL,
    'order_status' VARCHAR(200) NOT NULL,
    'recipient_first_name' VARCHAR(200) NOT NULL,
    'recipient_last_name' VARCHAR(200) NOT NULL,
    'recipient_phone_number' VARCHAR(200) NOT NULL,
    'delivery_address1' INT NOT NULL,
    'delivery_address2' VARCHAR(200) NOT NULL,
    'delivery_postcode' VARCHAR(6) NOT NULL,
    'delivery_type' VARCHAR(200) NOT NULL,
    'expected_delivery_date' DATE,
    'delivered_date' DATE,
    'delivery_instructions' TEXT,
    'voucher_id' VARCHAR(5),
    FOREIGN KEY ('voucher_id') REFERENCES Vouchers ('voucher_id'));
")

RSQLite::dbExecute(my_connection,"
  CREATE TABLE 'Order_Relationship' (
    'order_id' VARCHAR(5),
    'customer_id' VARCHAR(4),
    'product_id' VARCHAR(6),
    'order_quantity' INT,
    PRIMARY KEY (order_id,customer_id,product_id),
    FOREIGN KEY ('order_id') REFERENCES Order_Details ('order_id')
    FOREIGN KEY ('customer_id') REFERENCES Customers('customer_id'),
    FOREIGN KEY ('product_id') REFERENCES Products('product_id'));
")

RSQLite::dbExecute(my_connection,"
  CREATE TABLE 'Transactions' (
    'transaction_id' VARCHAR(5) PRIMARY KEY,
    'transaction_date' DATE NOT NULL,
    'transaction_status' VARCHAR(200) NOT NULL,
    'card_number' VARCHAR(200) NOT NULL,
    'order_id' VARCHAR(5) NOT NULL,
    FOREIGN KEY ('card_number') REFERENCES Cards ('card_number'),
    FOREIGN KEY ('order_id') REFERENCES Order_Details ('order_id'));
")
```

# load data
```{r load data}
Customers <- read_excel("old_data/MOCK_DATA.xlsx",sheet = "Customers")
Vouchers <- read_excel("old_data/MOCK_DATA.xlsx",sheet = "Vouchers")
Suppliers <- read_excel("old_data/MOCK_DATA.xlsx",sheet = "Suppliers")
Categories <- read_excel("old_data/MOCK_DATA.xlsx",sheet = "Categories")
Cards <- read_excel("old_data/MOCK_DATA.xlsx",sheet = "Cards")
Products <- read_excel("old_data/MOCK_DATA.xlsx",sheet = "Products")
Order_Details <- read_excel("old_data/MOCK_DATA.xlsx",sheet = "Order_Details")
Order_Relationship <- read_excel("old_data/MOCK_DATA.xlsx",sheet = "Order_Relationship")
Transactions <- read_excel("old_data/MOCK_DATA.xlsx",sheet = "Transactions")

```

# Insert the old data into tables
```{r}
RSQLite::dbWriteTable(my_connection,"Customers",Customers,append=TRUE)
RSQLite::dbWriteTable(my_connection,"Vouchers",Vouchers,append=TRUE)
RSQLite::dbWriteTable(my_connection,"Suppliers",Suppliers,append=TRUE)
RSQLite::dbWriteTable(my_connection,"Categories",Categories,append=TRUE)
RSQLite::dbWriteTable(my_connection,"Cards",Cards,append=TRUE)
RSQLite::dbWriteTable(my_connection,"Products",Products,append=TRUE)
RSQLite::dbWriteTable(my_connection,"Order_Details",Order_Details,append=TRUE)
RSQLite::dbWriteTable(my_connection,"Order_Relationship",Order_Relationship,append=TRUE)
RSQLite::dbWriteTable(my_connection,"Transactions",Transactions,append=TRUE)
```

# load and append new data into tables
```{r}
Order_Details_new <- read_excel("new_data/New_order.xlsx",sheet = "Order_Details")
Order_Relationship_new <- read_excel("new_data/New_order.xlsx",sheet = "Order_Relationships")

RSQLite::dbWriteTable(my_connection,"Order_Details",Order_Details_new,append=TRUE)
RSQLite::dbWriteTable(my_connection,"Order_Relationship",Order_Relationship_new,append=TRUE)
```

# Analysis
## top 10 product
```{r}
top_10_product_based_on_quantity <- function() {
  return(
          RSQLite::dbGetQuery(my_connection,"
            SELECT p.product_id, p.product_name,
                   SUM(or_rel.order_quantity) AS total_quantity_sold
            FROM Products p
            JOIN Order_Relationship or_rel ON p.product_id = or_rel.product_id
            GROUP BY p.product_id, p.product_name
            ORDER BY total_quantity_sold DESC
            LIMIT 10;
          ")
  )
}
```

```{r}
top_10_product_based_on_revenue <- function() {
    return(
            RSQLite::dbGetQuery(my_connection,"
              SELECT p.product_id, p.product_name,
                     SUM(or_rel.order_quantity * p.product_price) AS total_revenue
              FROM Products p
              JOIN Order_Relationship or_rel ON p.product_id = or_rel.product_id
              GROUP BY p.product_id, p.product_name
              ORDER BY total_revenue DESC
              LIMIT 10;
              ")
    )
}
```

## top 3 categories
```{r}
top_3_categories_based_on_quantity <- function() {
    return(
            RSQLite::dbGetQuery(my_connection,"
              SELECT c.category_id, c.category_name,
                     SUM(or_rel.order_quantity) AS total_quantity_sold
              FROM Categories c
              JOIN Products p ON c.category_id = p.category_id
              JOIN Order_Relationship or_rel ON p.product_id = or_rel.product_id
              GROUP BY c.category_id, c.category_name
              ORDER BY total_quantity_sold DESC
              LIMIT 3;
            ")
    )
}
```

```{r}
top_3_categories_based_on_revenue <- function() {
    return(
            RSQLite::dbGetQuery(my_connection,"
              SELECT c.category_id, c.category_name,
                     SUM(or_rel.order_quantity * p.product_price) AS total_revenue_generated
              FROM Categories c
              JOIN Products p ON c.category_id = p.category_id
              JOIN Order_Relationship or_rel ON p.product_id = or_rel.product_id
              GROUP BY c.category_id, c.category_name
              ORDER BY total_revenue_generated DESC
              LIMIT 3;
            ")
    )
}

```

## top 10 customers 
```{r}
top_10_customers_based_on_the_total_amount_spent_on_orders <- function() {
    return(
            RSQLite::dbGetQuery(my_connection,"
              SELECT c.customer_id, c.customer_first_name, c.customer_last_name,
                     SUM(p.product_price * or_rel.order_quantity) AS total_amount_spent
              FROM Customers c
              JOIN Order_Relationship or_rel ON c.customer_id = or_rel.customer_id
              JOIN Products p ON or_rel.product_id = p.product_id
              JOIN Transactions t ON or_rel.order_id = t.order_id
              GROUP BY c.customer_id, c.customer_first_name, c.customer_last_name
              ORDER BY total_amount_spent DESC
              LIMIT 10;
            ")
    )
}
```

## the most popular delivery_type
```{r}
the_most_popular_delivery_type_based_on_the_number_of_orders <- function() {
    return(
            RSQLite::dbGetQuery(my_connection,"
              SELECT delivery_type, COUNT(*) AS num_orders
              FROM Order_Details
              WHERE delivery_type IS NOT NULL
              GROUP BY delivery_type
              ORDER BY num_orders DESC
              LIMIT 1;
            ")
    )
}
```

## products that are running low (quantity less than 50)
```{r}
products_that_are_running_low <- function() {
    return(
            RSQLite::dbGetQuery(my_connection,"
              SELECT *
              FROM Products
              WHERE product_quantity < 50;
            ")
    )
}
```

## supplier performance
```{r}
supplier_performance_based_on_the_number_of_products_supplied <- function() {
    return(
            RSQLite::dbGetQuery(my_connection,"
              SELECT 
                  s.supplier_id,
                  s.supplier_name,
                  COUNT(DISTINCT p.product_id) AS num_products_supplied
              FROM 
                  Suppliers s
              LEFT JOIN 
                  Products p ON s.supplier_id = p.supplier_id
              GROUP BY 
                  s.supplier_id, s.supplier_name
              ;
            ")
    )
}
```

## Analyze the distribution of customers by gender and age groups
```{r by gender}
analyzing_distribution_of_customers_by_gender <- function() {
    return(
            RSQLite::dbGetQuery(my_connection,"
              SELECT 
                  customer_gender,
                  COUNT(*) AS customer_count
              FROM 
                  Customers
              GROUP BY 
                  customer_gender;
            ")
    )
}
```

```{r by age groups}
analyzing_distribution_of_customers_by_age_group <- function() {
    return(
            RSQLite::dbGetQuery(my_connection,"
              SELECT 
                  CASE
                      WHEN strftime('%Y', 'now') - strftime('%Y', formatted_date_of_birth) - 
                           (strftime('%m-%d', 'now') < strftime('%m-%d', formatted_date_of_birth)) BETWEEN 0 AND 18 THEN '0-18'
                      WHEN strftime('%Y', 'now') - strftime('%Y', formatted_date_of_birth) - 
                           (strftime('%m-%d', 'now') < strftime('%m-%d', formatted_date_of_birth)) BETWEEN 19 AND 30 THEN '19-30'
                      WHEN strftime('%Y', 'now') - strftime('%Y', formatted_date_of_birth) - 
                           (strftime('%m-%d', 'now') < strftime('%m-%d', formatted_date_of_birth)) BETWEEN 31 AND 45 THEN '31-45'
                      WHEN strftime('%Y', 'now') - strftime('%Y', formatted_date_of_birth) - 
                           (strftime('%m-%d', 'now') < strftime('%m-%d', formatted_date_of_birth)) BETWEEN 46 AND 60 THEN '46-60'
                      ELSE '61+'
                  END AS age_group,
                  COUNT(*) AS num_customers
              FROM 
                  (SELECT 
                      strftime('%Y-%m-%d', substr(customer_date_of_birth, 7) || '-' || substr(customer_date_of_birth, 4, 2) || '-' || substr(customer_date_of_birth, 1, 2)) AS formatted_date_of_birth
                  FROM 
                      Customers) AS converted_dates
              GROUP BY 
                  age_group
              ORDER BY 
                  MIN(strftime('%Y', 'now') - strftime('%Y', formatted_date_of_birth) - 
                      (strftime('%m-%d', 'now') < strftime('%m-%d', formatted_date_of_birth)));
            ")
    )
}
```

# write the analysis results into excel
```{r}
# Execute the functions and store results
result_top_10_product_based_on_quantity <- top_10_product_based_on_quantity()
result_top_10_product_based_on_revenue <- top_10_product_based_on_revenue()
result_top_3_categories_based_on_quantity <- top_3_categories_based_on_quantity()
result_top_3_categories_based_on_revenue <- top_3_categories_based_on_revenue()
result_top_10_customers_based_on_the_total_amount_spent_on_orders <- top_10_customers_based_on_the_total_amount_spent_on_orders()
result_the_most_popular_delivery_type_based_on_the_number_of_orders <- the_most_popular_delivery_type_based_on_the_number_of_orders()
result_products_that_are_running_low <- products_that_are_running_low()
result_supplier_performance_based_on_the_number_of_products_supplied <- supplier_performance_based_on_the_number_of_products_supplied()
result_analyzing_distribution_of_customers_by_gender <- analyzing_distribution_of_customers_by_gender()
result_analyzing_distribution_of_customers_by_age_group <- analyzing_distribution_of_customers_by_age_group()

# Create a new workbook
wb <- openxlsx::createWorkbook()

# Add sheets to the workbook
openxlsx::addWorksheet(wb, "Top 10 Products Quantity")
openxlsx::addWorksheet(wb, "Top 10 Products Revenue")
openxlsx::addWorksheet(wb, "Top 3 Categories Quantity")
openxlsx::addWorksheet(wb, "Top 3 Categories Revenue")
openxlsx::addWorksheet(wb, "Top 10 Customers Spent")
openxlsx::addWorksheet(wb, "Popular Delivery Type")
openxlsx::addWorksheet(wb, "Products Running Low")
openxlsx::addWorksheet(wb, "Supplier Performance")
openxlsx::addWorksheet(wb, "Customer Distribution by Gender")
openxlsx::addWorksheet(wb, "Customer Age Distribution")

# Write results to sheets
openxlsx::writeData(wb, "Top 10 Products Quantity", result_top_10_product_based_on_quantity)
openxlsx::writeData(wb, "Top 10 Products Revenue", result_top_10_product_based_on_revenue)
openxlsx::writeData(wb, "Top 3 Categories Quantity", result_top_3_categories_based_on_quantity)
openxlsx::writeData(wb, "Top 3 Categories Revenue", result_top_3_categories_based_on_revenue)
openxlsx::writeData(wb, "Top 10 Customers Spent", result_top_10_customers_based_on_the_total_amount_spent_on_orders)
openxlsx::writeData(wb, "Popular Delivery Type", result_the_most_popular_delivery_type_based_on_the_number_of_orders)
openxlsx::writeData(wb, "Products Running Low", result_products_that_are_running_low)
openxlsx::writeData(wb, "Supplier Performance", result_supplier_performance_based_on_the_number_of_products_supplied)
openxlsx::writeData(wb, "Customer Distribution by Gender", result_analyzing_distribution_of_customers_by_gender)
openxlsx::writeData(wb, "Customer Age Distribution", result_analyzing_distribution_of_customers_by_age_group)

# Save the workbook
openxlsx::saveWorkbook(wb, "analysis_results.xlsx", overwrite = TRUE)
```

```{r}
sales <- dbGetQuery(my_connection, "
  SELECT product_id, SUM(order_quantity) AS total_sales
  FROM Order_Relationship
  GROUP BY product_id
  ORDER BY total_sales DESC
  LIMIT 1
")

top_product_id <- sales$product_id[1]

product_sales <- dbGetQuery(my_connection, "
  SELECT DATE(datetime(od.order_date, 'unixepoch')) AS order_date, or_rel.order_quantity
  FROM Order_Details od
  INNER JOIN Order_Relationship or_rel ON od.order_id = or_rel.order_id
  WHERE or_rel.product_id = ?
", params = list(top_product_id))

product_sales$order_date <- as.Date(product_sales$order_date)

ggplot(product_sales, aes(x = order_date, y = order_quantity)) +
  geom_line() +
  labs(title = paste("Sales Trend of Product", top_product_id),
       x = "Date",
       y = "Sales Quantity")
```
# Customer:
## gender pie chart
```{r}
gender_counts_df <- as.data.frame(result_analyzing_distribution_of_customers_by_gender)
names(gender_counts_df) <- c("Gender", "Count")

gender_counts_df$Percent <- gender_counts_df$Count / sum(gender_counts_df$Count) * 100

# 绘制饼图
( gender_pie_chart <- ggplot(gender_counts_df, aes(x = "", y = Percent, fill = Gender)) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste(round(Percent), "%")), position = position_stack(vjust = 0.5)) +
  labs(title = "Customer Gender Distribution", fill = "Gender") +
  theme_minimal() +
  theme(legend.position = "right") +
  theme_void() +
  scale_fill_discrete(name = "Gender") )
```

## age violin chart
```{r}
age_data <- RSQLite::dbGetQuery(my_connection, "
    SELECT strftime('%Y', 'now') - strftime('%Y', formatted_date_of_birth) - 
                           (strftime('%m-%d', 'now') < strftime('%m-%d', formatted_date_of_birth))  AS age
    FROM 
                  (SELECT 
                      strftime('%Y-%m-%d', substr(customer_date_of_birth, 7) || '-' || substr(customer_date_of_birth, 4, 2) || '-' || substr(customer_date_of_birth, 1, 2)) AS formatted_date_of_birth
                  FROM 
                      Customers) AS converted_dates
")

age_data$age_group <- cut(age_data$age, breaks = c(0, 30,  Inf),
                          labels = c("0-30", "31+"))

# violin
( age_violin_chart <- ggplot(age_data, aes(x = age_group, y = age)) +
  geom_violin() +
  labs(title = "Distribution of Customer Age by Age Group",
       x = "Age Group", y = "Age") +
  theme_minimal() )
```

# Product
# product price distribution based on parent category 
```{r}
query <- "
  SELECT pc.category_name AS parent_category_name, p.product_price
  FROM Products p
  JOIN Categories c ON p.category_id = c.category_id
  JOIN Categories pc ON c.parent_category_id = pc.category_id;
"
product_price_data <- RSQLite::dbGetQuery(my_connection, query)

( product_price_distribution <- ggplot(product_price_data, aes(x = parent_category_name, y = product_price)) +
  geom_violin(trim = FALSE) + 
  labs(title = "Product Price Distribution Based on Parent Category", x = "Parent Category", y = "Product Price") +
  theme_minimal() )
```

## top 3 category based on sales
```{r}
( top_3_category_based_on_sales <- ggplot(result_top_3_categories_based_on_revenue, aes(x = category_name, y = total_revenue_generated)) +
  geom_bar(stat = "summary", fun = "mean", fill = "skyblue", color = "black") +
  labs(title = "top 3 category based on sales",
       x = "category name",
       y = "total sales generated") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) )
```

## top 10 products based on sales
```{r}
( top_10_products_based_on_sales <- ggplot(result_top_10_product_based_on_revenue, aes(x = product_name, y = total_revenue)) +
  geom_bar(stat = "summary", fun = "mean", fill = "skyblue", color = "black") +
  labs(title = "top 10 products based on sales",
       x = "product name",
       y = "total sales generated") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) )
```

# Cards
## the total of customers on number of cards
```{r}
number_of_customers_based_on_cards <- RSQLite::dbGetQuery(my_connection, "
  SELECT
      num_cards,
      COUNT(*) AS num_customers
  FROM (
      SELECT
          customer_id,
          COUNT(*) AS num_cards
      FROM
          Cards
      GROUP BY
          customer_id
  ) AS card_counts
  GROUP BY
      num_cards
  ORDER BY
      num_cards;
")

( total_customers_on_number_of_cards <- ggplot(number_of_customers_based_on_cards, aes(x = num_cards, y = num_customers)) +
  geom_bar(stat = "summary", fun = "mean", fill = "skyblue", color = "black") +
  labs(title = "the total of customers on number of cards",
       x = "number of cards",
       y = "the total of customers") +
  theme_minimal() )
```

# Suppliers
## top 3 suppliers
```{r}
( top_3_suppliers <- ggplot(result_supplier_performance_based_on_the_number_of_products_supplied[1:3,], aes(x = supplier_name, y = num_products_supplied)) +
  geom_bar(stat = "summary", fun = "mean", fill = "skyblue", color = "black") +
  labs(title = "top 3 suppliers",
       x = "supplier_name",
       y = "number of products supplied") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) )
```

# Order_details
## time series of order daily for 3 months
```{r}
time_series <- RSQLite::dbGetQuery(my_connection,"
    SELECT 
        strftime('%Y-%m-%d', datetime(order_date, 'unixepoch')) AS Order_Date,
        COUNT(order_id) AS order_amount
    FROM 
        Order_Details
    GROUP BY 
        order_date
    ORDER BY 
        order_date;
")

time_series$Order_Date <- as.POSIXct(time_series$Order_Date, origin = "1970-01-01")

( time_series_of_order_daily <- ggplot(time_series, aes(x = Order_Date, y = order_amount)) +
  geom_line() +
  labs(title = "time series of order daily for 3 months",
       x = "order date",
       y = "order amount")+
  theme_minimal()+
  scale_x_datetime(date_labels = "%Y-%m-%d") )
```

# Vouchers
## 5 most used voucher from orde
```{r}
# Calculate the usage count of each voucher
voucher_usage <- RSQLite::dbGetQuery(my_connection, "
  SELECT voucher_id, COUNT(*) AS usage_count
  FROM Order_Details
  WHERE voucher_id IS NOT NULL
  GROUP BY voucher_id
  ORDER BY usage_count DESC
  LIMIT 5
")

# Use mutate to calculate row number and mark the top two most used vouchers as 'highlight'
voucher_usage <- voucher_usage %>%
  mutate(highlight = ifelse(row_number() <= 2, "highlight", "normal"))

# Get the names of vouchers
voucher_names <- RSQLite::dbGetQuery(my_connection, "
  SELECT voucher_id, voucher_name
  FROM Vouchers
")

# Merge voucher usage count and names
voucher_usage <- merge(voucher_usage, voucher_names, by = "voucher_id")

# Draw the bar chart
(most_used_vouchers_from_order <- ggplot(voucher_usage, aes(x = reorder(voucher_name, -usage_count), y = usage_count, fill = highlight)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("highlight" = "pink", "normal" = "skyblue")) +
  labs(title = "Top 5 Most Used Vouchers",
       x = "Voucher",
       y = "Usage Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) )

```

# save each plot as a png file
```{r}
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))
ggsave(paste0("analysis_graphs/gender_pie_chart_",this_filename_date,"_",this_filename_time,".png"), plot = gender_pie_chart, width = 8, height = 6, units = "in")
ggsave(paste0("analysis_graphs/age_violin_chart_",this_filename_date,"_",this_filename_time,".png"), plot = age_violin_chart, width = 8, height = 6, units = "in")
ggsave(paste0("analysis_graphs/product_price_distribution_",this_filename_date,"_",this_filename_time,".png"), plot = product_price_distribution, width = 8, height = 6, units = "in")
ggsave(paste0("analysis_graphs/top_3_category_based_on_sales_",this_filename_date,"_",this_filename_time,".png"), plot = top_3_category_based_on_sales, width = 8, height = 6, units = "in")
ggsave(paste0("analysis_graphs/top_10_products_based_on_sales_",this_filename_date,"_",this_filename_time,".png"), plot = top_10_products_based_on_sales, width = 8, height = 6, units = "in")
ggsave(paste0("analysis_graphs/total_customers_on_number_of_cards_",this_filename_date,"_",this_filename_time,".png"), plot = total_customers_on_number_of_cards, width = 8, height = 6, units = "in")
ggsave(paste0("analysis_graphs/top_3_suppliers_",this_filename_date,"_",this_filename_time,".png"), plot = top_3_suppliers, width = 8, height = 6, units = "in")
ggsave(paste0("analysis_graphs/time_series_of_order_daily_",this_filename_date,"_",this_filename_time,".png"), plot = time_series_of_order_daily, width = 8, height = 6, units = "in")
ggsave(paste0("analysis_graphs/most_used_vouchers_from_order_",this_filename_date,"_",this_filename_time,".png"), plot = most_used_vouchers_from_order, width = 8, height = 6, units = "in")

```







